# æµ‹è¯•å¹³å°å®æˆ˜ - 3

## ä¸€ã€ æ•°æ®åº“é…ç½®

### 1. æ­å»º MySQL æ•°æ®åº“


::: cardList 2
``` yaml
- name: æ•°æ®åº“æ­å»º
  desc: ğŸš€CentOS 8 æ­å»º MySQL 8
  link: https://pupper.cn/pages/631812/
  bgColor: '#DFEEE7'
  textColor: '#2A3344'
```
:::

### 2. åˆ›å»ºæ•°æ®åº“

```mysql
CREATE DATABASE `course_autotp` DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
```

![image-20210611151334421](https://pupperc.com/img/20210611151334.png)

### 3. å®‰è£… pymysqlclient æ¨¡å—

```shell
# é“¾æ¥ mysql æ•°æ®åº“éœ€è¦æ­¤æ¨¡å—,æ­¤æ¨¡å—å®‰è£…ä¸äº†çš„ï¼Œå‚è€ƒé™„å½•çš„æ–¹æ³•

pip install mysqlclient 
```

![image-20210611151605352](https://pupperc.com/img/20210611151605.png)

### 4. é…ç½® æ•°æ®åº“å‚æ•°

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'course_autotp',    # æ•°æ®åº“åç§°
        'USER': 'root',     # ç”¨æˆ·å
        'PASSWORD': 'xxxx',   # å¯†ç 
        'HOST': '158.247.205.137',
        'PORT': '3306',
        'TEST': {
            'CHARSET': 'utf8',      # æ•°æ®åº“çš„ç¼–ç é…ç½®
            'COLLATION': 'utf8_general_ci',
        }
    }
}
```

![image-20210611152942197](https://pupperc.com/img/20210611152942.png)

## äºŒã€ æ•°æ®åº“è®¾è®¡

![image-20210611153541212](https://pupperc.com/img/20210611153541.png)

### 1. ä¸€å¯¹ä¸€ å…³ç³»

1å¯¹1å°±æ˜¯1ä¸ªæ¨¡å‹å…³è”å¦ä¸€ä¸ªæ¨¡å‹ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»æ˜¯1å¯¹1  

ä¸€å¯¹ä¸€å…³è”ä¸å¤šå¯¹ä¸€å…³è”éå¸¸ç±»ä¼¼ã€‚è‹¥åœ¨æ¨¡å‹ä¸­å®šä¹‰äº† [OneToOneField](https://docs.djangoproject.com/zh-hans/3.2/ref/models/fields/#django.db.models.OneToOneField) ï¼Œè¯¥æ¨¡å‹çš„å®ä¾‹åªéœ€é€šè¿‡å…¶å±
æ€§å°±èƒ½è®¿é—®å…³è”å¯¹è±¡  

```python
class EntryDetail(models.Model):
	entry = models.OneToOneField(Entry, on_delete=models.CASCADE)
	details = models.TextField()
	
ed = EntryDetail.objects.get(id=2)
ed.entry # Returns the related Entry object.
```

ä¸åŒç‚¹åœ¨äº â€œåå‘â€ æŸ¥è¯¢ã€‚ä¸€å¯¹ä¸€å…³è”æ‰€å…³è”çš„å¯¹è±¡ä¹Ÿèƒ½è®¿é—® Manager å¯¹è±¡ï¼Œä½†è¿™ä¸ª Manager ä»…ä»£è¡¨
ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯å¯¹è±¡çš„é›†åˆ(QuerySet):  

```python
e = Entry.objects.get(id=2)
e.entrydetail # returns the related EntryDetail object
```

è‹¥æœªä¸ºå…³è”å…³ç³»æŒ‡å®šå¯¹è±¡ï¼ŒDjango ä¼šæŠ›å‡º DoesNotExist å¼‚å¸¸ã€‚

å®ä¾‹èƒ½é€šè¿‡ä¸ºæ­£å‘å…³è”æŒ‡å®šå…³è”å¯¹è±¡ä¸€æ ·çš„æ–¹å¼æŒ‡å®šç»™åå‘å…³è”:  

```python
e.entrydetail = ed
```

### 2. æ¨¡å‹ä»£ç è®¾è®¡

 å…¶ä¸­ï¼Œrequestï¼Œstepå’Œconfigå‚è€ƒHRå¯¹åº”éƒ¨åˆ†çš„å­—æ®µï¼Œç”±äºå…¶ä¸­ä¼šå‡ºç°å¾ˆå¤šåµŒå¥—å­—æ®µï¼Œæ‰€ä»¥1å±‚çš„å­—æ®µ
å°±ç”¨jsonæ•°æ®ç±»å‹æ¥ä»£æ›¿  

```python
from django.db import models


class Config(models.Model):
    name = models.CharField('åç§°', max_length=128)
    # å¯ null å¯ç©ºç™½
    base_url = models.CharField('IP/åŸŸå', max_length=512, null=True, blank=True)
    variables = models.JSONField('å˜é‡', null=True)
    parameters = models.JSONField('å‚æ•°', null=True)  # ç”¨äºå‚æ•°åŒ–
    verify = models.BooleanField('httpsæ ¡éªŒ', default=False)
    export = models.JSONField('ç”¨ä¾‹è¿”å›å€¼', null=True)
    def __str__(self):
        return self.name


class Step(models.Model):
    # åŒæ¨¡å‹ä¸­ï¼Œä¸¤ä¸ªå­—æ®µå…³è”ä¸€ä¸ªæ¨¡å‹æ—¶ï¼Œéœ€è¦æŒ‡å®š related_nameï¼Œ ä¸”åå­—ä¸èƒ½ç›¸åŒ
    # å±äºå“ªä¸ªç”¨ä¾‹
    belong_case = models.ForeignKey('Case', on_delete=models.CASCADE, related_name='test_steps')
    # å¼•ç”¨é‚£æ¡ç”¨ä¾‹
    linked_case = models.ForeignKey('Case', on_delete=models.SET_NULL, null=True, related_name='linked_steps')
    name = models.CharField('åç§°', max_length=128)
    variables = models.JSONField('å˜é‡', null=True)
    extract = models.JSONField('è¯·æ±‚è¿”å›å€¼', null=True)
    validate = models.JSONField('æ ¡éªŒé¡¹', null=True)
    setup_hooks = models.JSONField('åˆå§‹åŒ–', null=True)
    teardown_hooks = models.JSONField('æ¸…é™¤', null=True)
    def __str__(self):
        return self.name


class Request(models.Model):
    method_choices = (  # method å¯é€‰å­—æ®µï¼Œ äºŒç»´å…ƒç»„
        (0, 'GET'),  # å‚æ•° 1 ï¼š ä¿å­˜åœ¨æ•°æ®åº“ä¸­çš„å€¼ ï¼Œå‚æ•° 2 ï¼š å¯¹ä½æ˜¾ç¤ºçš„å€¼
        (1, 'POST'),
        (2, 'PUT'),
        (3, 'DELETE'),
    )
    step = models.OneToOneField(Step, on_delete=models.CASCADE, null=Trueï¼Œ , related_name='testrequest')
    method = models.SmallIntegerField('è¯·æ±‚æ–¹æ³•', choices=method_choices, default=0)
    url = models.CharField('è¯·æ±‚è·¯å¾„', default='/', max_length=1000)
    params = models.JSONField('urlå‚æ•°', null=True)
    headers = models.JSONField('è¯·æ±‚å¤´', null=True)
    cookies = models.JSONField('cookies', null=True)
    data = models.JSONField('dataå‚æ•°', null=True)
    json = models.JSONField('jsonå‚æ•°', null=True)
    def __str__(self):
        return self.url


class Case(models.Model):
    config = models.OneToOneField(Config, on_delete=models.DO_NOTHING)
    suite = models.ForeignKey('Suite', on_delete=models.DO_NOTHING, null=True)
    file_path = models.CharField('ç”¨ä¾‹æ–‡ä»¶è·¯å¾„', max_length=1000, default='demo_case.json')
    def __str__(self):
        return self.config.name


class Suite(models.Model):
    config = models.OneToOneField(Config, on_delete=models.DO_NOTHING)
    file_path = models.CharField('å¥—ä»¶æ–‡ä»¶è·¯å¾„', max_length=1000, default='demo_suite.json')
    def __str__(self):
        return self.config.name
```

### 3. åŒæ­¥æ•°æ®åº“

ç”Ÿæˆ æ•°æ®åº“ åŒæ­¥ æ–‡ä»¶

```shell
python manage.py makemigrations
```

![image-20210611154549040](https://pupperc.com/img/20210611154549.png)

åŒæ­¥æ•°æ®åº“

```shell
python manage.py migrate
```

![image-20210611154653748](https://pupperc.com/img/20210611154653.png)

## ä¸‰ã€ åå‘æŸ¥è¯¢æ¦‚å¿µè§£æ  

### 1. æ­£å‘æŸ¥è¯¢

æ¨¡å‹æŸ¥è¯¢å…¶å…³è”çš„é¡¹ç›®å«åšæ­£å‘æŸ¥è¯¢ï¼ˆå¤–é”®å®šä¹‰åœ¨æ¨¡å‹ï¼‰

ä¾‹å¦‚ï¼šæ­¥éª¤æŸ¥è¯¢å…¶æ‰€åœ¨çš„ç”¨ä¾‹  

```python
# test.py

class TestRelatedQuery(TestCase):
    def setUp(self) -> None:
        # åˆ›å»ºå¥—ä»¶å’Œç”¨ä¾‹
        self.config = Config.objects.create(name='ç”¨ä¾‹1')
        self.case = Case.objects.create(config=self.config)

        self.config_suite = Config.objects.create(name='å¥—ä»¶1')
        self.suite = Suite.objects.create(config=self.config_suite)

    def test_case_suite(self):
        # ç”¨ä¾‹å…³è”å¥—ä»¶
        self.case.suite = self.suite
        # ä¿å­˜æ•°æ®åº“
        self.case.save()
        print(self.case.suite)      # æ­£å‘æŸ¥è¯¢-- æŸ¥è¯¢æ‰€å±å¥—ä»¶
        print(self.case.config)     # æ­£å‘æŸ¥è¯¢ -- æŸ¥è¯¢é…ç½®
```

### 2. åå‘æŸ¥è¯¢

åè¿‡æ¥ï¼Œé¡¹ç›®æŸ¥è¯¢ä¸‹é¢çš„æ¨¡å‹å«åšåå‘æŸ¥è¯¢ï¼Œé€šè¿‡åå‘æŸ¥è¯¢çš„ç»“æœQuerySet

-   æœªæŒ‡å®š related_name æ—¶

    -   å¤šå¯¹å¤š æˆ– å¤šå¯¹ä¸€

        `modelobj.field_set.all()`

    -   ä¸€å¯¹ä¸€

        `modelobj.field`

```python
class TestRelatedQuery(TestCase):
    def setUp(self) -> None:
        # åˆ›å»ºå¥—ä»¶å’Œç”¨ä¾‹
        self.config = Config.objects.create(name='ç”¨ä¾‹1')
        self.case = Case.objects.create(config=self.config)
        self.config_suite = Config.objects.create(name='å¥—ä»¶1')
        self.suite = Suite.objects.create(config=self.config_suite)

    def test_case_suite(self):
        self.case.suite = self.suite	# ç”¨ä¾‹å…³è”å¥—ä»¶
        self.case.save()	# ä¿å­˜æ•°æ®åº“

        # åå‘æŸ¥è¯¢ --- å¤šå¯¹ä¸€ æˆ– å¤šå¯¹å¤š
        # å¥—ä»¶æŸ¥è¯¢å…³è”çš„ç”¨ä¾‹ --- æ•°æ®å¯¹è±¡.å¤šæ–¹å±æ€§_set.all() --- è¿”å›çš„æ˜¯ QuerySetï¼ˆæŸ¥è¯¢é›†ï¼‰
        print(self.suite.case_set.all())

        # åå‘æŸ¥è¯¢ --- ä¸€å¯¹ä¸€
        # é…ç½®å¯¹åº”çš„ç”¨ä¾‹ --- æ•°æ®å¯¹è±¡.åå‘å…³ç³»æ¨¡å‹å°å†™
        print(self.config.case)
```

æ–¹å¼2ï¼šæŒ‡å®šrelated_nameæ—¶

`modelobj.related_name.all()`  

```python
class TestRelatedQuery(TestCase):
    def setUp(self) -> None:
        # åˆ›å»ºå¥—ä»¶å’Œç”¨ä¾‹
        self.config = Config.objects.create(name='ç”¨ä¾‹1')
        self.case = Case.objects.create(config=self.config)

        self.config_suite = Config.objects.create(name='å¥—ä»¶1')
        self.suite = Suite.objects.create(config=self.config_suite)

    def test_step_case(self):
        self.step = Step.objects.create(belong_case=self.case, name='æ­¥éª¤1')
        Step.objects.create(belong_case=self.case, name='æ­¥éª¤2')
        Step.objects.create(belong_case=self.case, name='æ­¥éª¤3')
        # å¤šå¯¹å¤š åå‘æŸ¥è¯¢
        print(self.case.test_steps.all())

    def test_step_request(self):
        self.step = Step.objects.create(belong_case=self.case, name='æ­¥éª¤1')
        self.request = Request.objects.create(url='/demo/example', step=self.step)

        # ä¸€å¯¹ä¸€ å…³ç³»åå‘æŸ¥è¯¢
        print(self.step.testrequest)
```

## å››ã€ json å­—æ®µæ“ä½œ

### 1ã€ å¢

```python
class TestJsonOperate(TestCase):
    def test_add(self):
        req1 = Request.objects.create(url='/demo1', data={'name': 'å°æ˜', 'age': '18', 'addr': 'æ–°ä¸–çºªå¤§é“'})
        print(req1.data)
        req2 = Request.objects.create(url='/demo1', params={'name': 'å°æ˜', 'age': '18', 'addr': 'æ–°ä¸–çºªå¤§é“'})
        print(req2.params)
```

### 2. æ”¹

```python
def test_update(self):
    req1 = Request.objects.create(url='/demo1', data={'name': 'å°æ˜', 'age': '18', 'addr': 'æ–°ä¸–çºªå¤§é“'})

    # æ•´ä½“ä¿®æ”¹
    req1.data = {'city': 'beijing'}
    req1.save()
    print(req1.data)

    # å±€éƒ¨ä¿®æ”¹
    req1.data['name'] = 'å°çº¢'
    req1.save()
    print(req1.data)
```

### 3. åˆ 

```python
def test_delete(self):
    req1 = Request.objects.create(url='/demo1', data={'name': 'å°æ˜', 'age': '18', 'addr': 'æ–°ä¸–çºªå¤§é“'})
    req1.data = None       # sql çš„ none
    req1.save()
    print(req1.data)
    # æŸ¥è¯¢çš„æ—¶å€™å…³ç³» å­—æ®µ ç­‰äº sql çš„ null
    res = Request.objects.filter(data__isnull=True)
    print(res)

    req1.data = Value('null')       # json çš„ none
    req1.save()
    # æŸ¥è¯¢çš„å…³ç³» å­—æ®µ ç­‰äº json çš„ null
    res = Request.objects.filter(data=None)
    print(res)
```

### 4. æŸ¥

```python
def test_query(self):
    req1 = Request.objects.create(url='/demo1', data={'name': 'å°æ˜', 'age': '18', 'addr': 'æ–°ä¸–çºªå¤§é“','father':{'age':40}})
    res = Request.objects.filter(data__father__age=40)
    print(res)
```

